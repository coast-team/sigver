#!/usr/bin/env node
function error(r,e,n){console.log("Error "+e+": "+n),r.close(e,n)}function start(r,e){var n=arguments.length<=2||void 0===arguments[2]?function(){}:arguments[2];server=new WebSocketServer({host:r,port:e},function(){console.log("Server runs on: "+r+":"+e),n()}),server.on("connection",function(r){r.on("message",function(e){var n=void 0;try{n=JSON.parse(e)}catch(e){error(r,DATA_SYNTAX_ERROR,"Server accepts only JSON")}try{if("key"in n){var o=!0,t=!1,i=void 0;try{for(var s,a=server.clients[Symbol.iterator]();!(o=(s=a.next()).done);o=!0){var l=s.value;if(l.key===n.key)return void error(r,KEY_ALREADY_EXISTS,"The key already exists")}}catch(r){t=!0,i=r}finally{try{!o&&a.return&&a.return()}finally{if(t)throw i}}r.key=n.key,r.joiningClients=[]}else if("id"in n){for(var v in r.joiningClients)if(v===n.id.toString())return void r.joiningClients[v].send(JSON.stringify({data:n.data}));r.send(JSON.stringify({id:n.id,unavailable:!0}))}else if("join"in n){var c=!0,f=!1,d=void 0;try{for(var p,y=server.clients[Symbol.iterator]();!(c=(p=y.next()).done);c=!0){var g=p.value;if(g.key===n.join){r.master=g,g.joiningClients.push(r);var N=g.joiningClients.length-1;return void g.send(JSON.stringify({id:N,data:n.data}))}}}catch(r){f=!0,d=r}finally{try{!c&&y.return&&y.return()}finally{if(f)throw d}}error(r,KEY_UNKNOWN,"Unknown key")}else if("data"in n&&"master"in r){var E=r.master.joiningClients.indexOf(r);r.master.readyState===WebSocket.OPEN&&r.master.send(JSON.stringify({id:E,data:n.data}))}else console.log("data: ",n),error(r,DATA_UNKNOWN_ATTRIBUTE,"Unsupported message format")}catch(e){error(r,DATA_SYNTAX_ERROR,"server accepts only JSON")}}),r.on("close",function(e){if("joiningClients"in r){var n=!0,o=!1,t=void 0;try{for(var i,s=r.joiningClients[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;a.close(KEY_NO_LONGER_AVAILABLE,"The peer is no longer available")}}catch(r){o=!0,t=r}finally{try{!n&&s.return&&s.return()}finally{if(o)throw t}}}})})}var WebSocketServer=require("ws").Server,WebSocket=require("ws"),DATA_SYNTAX_ERROR=4e3,DATA_UNKNOWN_ATTRIBUTE=4001,KEY_ALREADY_EXISTS=4002,KEY_UNKNOWN=4003,KEY_NO_LONGER_AVAILABLE=4004,server=void 0,program=require("commander"),host=process.env.NODE_IP||"localhost",port=process.env.NODE_PORT||8e3;program.version("7.4.2","-v, --version").option("-h, --host <n>",'specify host (DEFAULT: process.env.NODE_IP || "localhost")').option("-p, --port <n>","specify port (DEFAULT: process.env.NODE_PORT || 8000)").on("--help",function(){console.log("  Examples:\n\n     $ sigver\n     $ sigver -h 192.168.0.1 -p 9000\n")}).parse(process.argv),program.host&&(host=program.host),program.port&&(port=program.port),start(host,port);