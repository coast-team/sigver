#!/usr/bin/env node
function error(e,r,n){console.log("Error "+r+": "+n),e.close(r,n)}function start(e){Object.assign(settings,e),server=new WebSocketServer(settings,function(){console.log("Server runs on: "+settings.host+":"+settings.port),settings.onStart()}),server.on("connection",function(e){e.on("message",function(r){var n=void 0;try{n=JSON.parse(r)}catch(r){error(e,DATA_SYNTAX_ERROR,"Server accepts only JSON")}try{if("key"in n){var t=!0,o=!1,i=void 0;try{for(var s,a=server.clients[Symbol.iterator]();!(t=(s=a.next()).done);t=!0){var l=s.value;if(l.key===n.key)return void error(e,KEY_ALREADY_EXISTS,"The key already exists")}}catch(e){o=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(o)throw i}}e.key=n.key,e.joiningClients=[]}else if("id"in n){for(var c in e.joiningClients)if(c===n.id.toString())return void e.joiningClients[c].send(JSON.stringify({data:n.data}));e.send(JSON.stringify({id:n.id,unavailable:!0}))}else if("join"in n){var v=!0,f=!1,g=void 0;try{for(var y,d=server.clients[Symbol.iterator]();!(v=(y=d.next()).done);v=!0){var p=y.value;if(p.key===n.join){e.master=p,p.joiningClients.push(e);var N=p.joiningClients.length-1;return void p.send(JSON.stringify({id:N,data:n.data}))}}}catch(e){f=!0,g=e}finally{try{!v&&d.return&&d.return()}finally{if(f)throw g}}error(e,KEY_UNKNOWN,"Unknown key")}else if("data"in n&&"master"in e){var S=e.master.joiningClients.indexOf(e);e.master.readyState===WebSocket.OPEN&&e.master.send(JSON.stringify({id:S,data:n.data}))}else console.log("data: ",n),error(e,DATA_UNKNOWN_ATTRIBUTE,"Unsupported message format")}catch(r){error(e,DATA_SYNTAX_ERROR,"server accepts only JSON")}}),e.on("close",function(r){if("joiningClients"in e){var n=!0,t=!1,o=void 0;try{for(var i,s=e.joiningClients[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;a.close(KEY_NO_LONGER_AVAILABLE,"The peer is no longer available")}}catch(e){t=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(t)throw o}}}})})}var WebSocketServer=require("ws").Server,WebSocket=require("ws"),DATA_SYNTAX_ERROR=4e3,DATA_UNKNOWN_ATTRIBUTE=4001,KEY_ALREADY_EXISTS=4002,KEY_UNKNOWN=4003,KEY_NO_LONGER_AVAILABLE=4004,settings={host:process.env.NODE_IP||"localhost",port:process.env.NODE_PORT||8e3,onStart:function(){}},server=void 0,program=require("commander");program.version("7.3.0","-v, --version").option("-h, --host <n>",'specify host (DEFAULT: process.env.NODE_IP || "localhost")').option("-p, --port <n>","specify port (DEFAULT: process.env.NODE_PORT || 8000)").on("--help",function(){console.log("  Examples:\n\n     $ sigver\n     $ sigver -h 192.168.0.1 -p 9000\n")}).parse(process.argv),start({host:program.host,port:program.port});