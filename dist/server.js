#!/usr/bin/env node
var Y=Object.create;var S=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,ee=Object.prototype.hasOwnProperty;var te=n=>S(n,"__esModule",{value:!0});var ne=(n,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of Q(r))!ee.call(n,o)&&(e||o!=="default")&&S(n,o,{get:()=>r[o],enumerable:!(t=q(r,o))||t.enumerable});return n},d=(n,r)=>ne(te(S(n!=null?Y(Z(n)):{},"default",!r&&n&&n.__esModule?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n);var N=require("commander"),M=d(require("fs")),J=d(require("http")),K=d(require("https"));var w=d(require("pino")),re=process.env.NODE_ENV==="development"?"debug":"info",u=(0,w.default)({name:"sigver",level:re});var j=d(require("url")),W=d(require("ws"));var H=require("rxjs"),m=require("rxjs/operators");var G=d(require("crypto")),_=2147483647,E=new Set,g=class extends Error{constructor(r,e=""){super();this.name=this.constructor.name,this.code=r,this.message=`${r}: ${e}`}},P=4741,$=4742,y=4743,D=4744,R=4745,F=512;function C(n){if(n==="")throw new g(P,`The key ${n} is an empty string`);if(n.length>F)throw new g(P,`The key length exceeds the limit of ${F} characters`)}function v(){let n=G.randomBytes(4).readUInt32BE(0);return n>_&&(n-=_),n===0||E.has(n)?v():(E.add(n),n)}function k(n){E.delete(n)}var T=new Map;function L(n,r,e,t){let o=n.group||T.get(t);if(o===void 0)return o=new U(t),o.addMember(n,r),T.set(t,o),!0;if(o.size===1){if(n.group!==void 0)return!0;if(o.hasMembersInCommon(e))return o.addMember(n,r),!0;let i=o.getFirstMember();if(n.triedMembers.includes(i.netfluxId))return o.addMember(n,r),o.removeMember(i),i.close(D,"replaced by a peer as prevented him from joining the group"),!0}return o.hasMembersInCommon(e)?(o.addMember(n,r),!0):(o.removeMember(n),n.bindWith(o.selectMemberFor(n)),!1)}var U=class{constructor(r){this.key=r,this.members=new Set}get size(){return this.members.size}getFirstMember(){return this.members.values().next().value}hasMembersInCommon(r){if(r.length!==0){for(let e of this.members)if(r.includes(e.netfluxId))return!0}return!1}addMember(r,e){return r.becomeMember(this,e),this.members.add(r),!0}removeMember(r){r.noLongerAMember(),this.members.delete(r),this.size===0&&T.delete(this.key)}selectMemberFor(r){let e;for(let t of this.members){let o=t.netfluxId;if(o!==void 0&&!r.triedMembers.includes(o)){if(t.favored)return t;e===void 0&&(e=t)}}return e!==void 0?e:(r.triedMembers=[],this.selectMemberFor(r))}};var l=d(require("protobufjs/minimal")),p=l.Reader,x=l.Writer,I=l.util,a=l.roots.default||(l.roots.default={}),b=a.Message=(()=>{function n(e){if(e)for(let t=Object.keys(e),o=0;o<t.length;++o)e[t[o]]!=null&&(this[t[o]]=e[t[o]])}n.prototype.heartbeat=null,n.prototype.content=null,n.prototype.connect=null,n.prototype.connected=null;let r;return Object.defineProperty(n.prototype,"type",{get:I.oneOfGetter(r=["heartbeat","content","connect","connected"]),set:I.oneOfSetter(r)}),n.encode=function(t,o){return o||(o=x.create()),t.heartbeat!=null&&Object.hasOwnProperty.call(t,"heartbeat")&&o.uint32(8).bool(t.heartbeat),t.content!=null&&Object.hasOwnProperty.call(t,"content")&&a.Content.encode(t.content,o.uint32(18).fork()).ldelim(),t.connect!=null&&Object.hasOwnProperty.call(t,"connect")&&a.GroupData.encode(t.connect,o.uint32(26).fork()).ldelim(),t.connected!=null&&Object.hasOwnProperty.call(t,"connected")&&o.uint32(32).bool(t.connected),o},n.decode=function(t,o){t instanceof p||(t=p.create(t));let i=o===void 0?t.len:t.pos+o,s=new a.Message;for(;t.pos<i;){let c=t.uint32();switch(c>>>3){case 1:s.heartbeat=t.bool();break;case 2:s.content=a.Content.decode(t,t.uint32());break;case 3:s.connect=a.GroupData.decode(t,t.uint32());break;case 4:s.connected=t.bool();break;default:t.skipType(c&7);break}}return s},n})(),ve=a.Content=(()=>{function n(r){if(r)for(let e=Object.keys(r),t=0;t<e.length;++t)r[e[t]]!=null&&(this[e[t]]=r[e[t]])}return n.prototype.senderId=0,n.prototype.recipientId=0,n.prototype.lastData=!1,n.prototype.data=I.newBuffer([]),n.encode=function(e,t){return t||(t=x.create()),e.senderId!=null&&Object.hasOwnProperty.call(e,"senderId")&&t.uint32(8).uint32(e.senderId),e.recipientId!=null&&Object.hasOwnProperty.call(e,"recipientId")&&t.uint32(16).uint32(e.recipientId),e.lastData!=null&&Object.hasOwnProperty.call(e,"lastData")&&t.uint32(24).bool(e.lastData),e.data!=null&&Object.hasOwnProperty.call(e,"data")&&t.uint32(34).bytes(e.data),t},n.decode=function(e,t){e instanceof p||(e=p.create(e));let o=t===void 0?e.len:e.pos+t,i=new a.Content;for(;e.pos<o;){let s=e.uint32();switch(s>>>3){case 1:i.senderId=e.uint32();break;case 2:i.recipientId=e.uint32();break;case 3:i.lastData=e.bool();break;case 4:i.data=e.bytes();break;default:e.skipType(s&7);break}}return i},n})(),Ie=a.GroupData=(()=>{function n(r){if(this.members=[],r)for(let e=Object.keys(r),t=0;t<e.length;++t)r[e[t]]!=null&&(this[e[t]]=r[e[t]])}return n.prototype.id=0,n.prototype.members=I.emptyArray,n.encode=function(e,t){if(t||(t=x.create()),e.id!=null&&Object.hasOwnProperty.call(e,"id")&&t.uint32(8).uint32(e.id),e.members!=null&&e.members.length){t.uint32(18).fork();for(let o=0;o<e.members.length;++o)t.uint32(e.members[o]);t.ldelim()}return t},n.decode=function(e,t){e instanceof p||(e=p.create(e));let o=t===void 0?e.len:e.pos+t,i=new a.GroupData;for(;e.pos<o;){let s=e.uint32();switch(s>>>3){case 1:i.id=e.uint32();break;case 2:if(i.members&&i.members.length||(i.members=[]),(s&7)===2){let c=e.uint32()+e.pos;for(;e.pos<c;)i.members.push(e.uint32())}else i.members.push(e.uint32());break;default:e.skipType(s&7);break}}return i},n})();var oe=3,ie=5e3,se=b.encode({heartbeat:!0}).finish(),ce=b.encode({connected:!0}).finish(),ae=b.encode({connected:!1}).finish(),O=class extends H.Subject{constructor(r,e,t,o){super();this.favored=e,this.triedMembers=[],this.netfluxId=void 0,this.signalingId=v(),this.closeFunc=o,this.sendFunc=t,this.subscribe(s=>{switch(s.type){case"connect":{let{id:c,members:f}=s.connect;L(this,c,f,r)?t(ce):t(ae);break}case"heartbeat":i=0;break;case void 0:this.close(y,"Wrong message format or unknown message");break}});let i=0;this.heartbeatInterval=setInterval(()=>{i++,i>=oe&&(clearInterval(this.heartbeatInterval),this.close($,"Too many missed hearbeats")),t(se)},ie)}send(r){this.sendFunc(b.encode(r).finish())}close(r,e){this.closeFunc(r,e)}onMessage(r){try{this.next(b.decode(r))}catch(e){this.close(y,e.message)}}becomeMember(r,e){this.group=r,this.triedMembers=[],this.netfluxId=e}noLongerAMember(){this.group=void 0,this.netfluxId=void 0}onClose(){clearInterval(this.heartbeatInterval),this.group!==void 0&&this.group.removeMember(this),this.complete(),k(this.signalingId)}bindWith(r){this.subToMember!==void 0&&this.subToMember.unsubscribe(),this.subToJoining!==void 0&&this.subToJoining.unsubscribe(),k(this.signalingId),this.signalingId=v(),this.triedMembers.push(r.netfluxId),this.subToMember=r.pipe((0,m.filter)(({content:e})=>e!=null&&e.recipientId===this.signalingId),(0,m.pluck)("content")).subscribe(({lastData:e,data:t})=>{this.send({content:{recipientId:this.signalingId,senderId:0,data:t}}),e&&this.subToMember.unsubscribe()},()=>this.send({content:{recipientId:this.signalingId,senderId:0}}),()=>this.send({content:{recipientId:this.signalingId,senderId:0}})),this.subToJoining=this.pipe((0,m.filter)(({content:e})=>e!=null),(0,m.pluck)("content")).subscribe(({lastData:e,data:t})=>{r.send({content:{recipientId:0,senderId:this.signalingId,data:t}}),e&&this.subToJoining.unsubscribe()},()=>r.send({content:{recipientId:0,senderId:this.signalingId}}),()=>r.send({content:{recipientId:0,senderId:this.signalingId}}))}};function B(n){let r=new W.default.Server({perMessageDeflate:!1,server:n});return r.on("error",e=>u.fatal("WebSocketServer error",e)),r.on("connection",(e,t)=>{try{if(t.url===void 0)throw new Error("URL is undefined");let{key:o,favored:i}=le(t.url);C(o);let s=new O(o,i,c=>{try{e.send(c)}catch(f){u.error("Fail to send data",f.message),e.close(R,f.message)}},(c,f)=>e.close(c,f));e.onmessage=({data:c})=>{c instanceof Uint8Array?s.onMessage(c):(u.error("Wrong data type"),s.close(y,"Wrong data type"))},e.onerror=c=>s.error(c),e.onclose=()=>s.onClose()}catch(o){u.error("WebSocket connection error: ",o.message),e.close(o.code,o.message)}}),r}function le(n){let{pathname:r,query:e}=j.parse(n,!0);if(r==null)throw new g(R,"URL pathname is undefined");return{key:r.slice(1),favored:"favored"in e}}var de="0.0.0.0",ue="8000",A=new N.Command;A.version("21.1.0").description("Signaling server for WebRTC. Used by Netflux API (https://coast-team.github.io/netflux/)").option("-h, --host <ip>","Select host address to bind to",de).option("-p, --port <number>","Select port to use",ue).option("-k, --key <file path>","Private key for the certificate.").option("-c, --cert <file path>","The server certificate.").option("-a, --ca <file path>","The additional intermediate certificate or certificates that web browsers will need in order to validate the server certificate.").on("--help",()=>{console.log(`
Examples:

  $ sigver                       # Signaling server is listening on 0.0.0.0:8000
  $ sigver -h 192.168.0.1 -p 80  # Signaling server is listening on 192.168.0.1:80
  $ sigver --key ./private.key --cert ./primary.crt --ca ./intermediate.crt --port 443  # Signaling server is listening on 0.0.0.0:443`)});A.parse(process.argv);var{host:fe,port:pe,key:V,cert:z,ca:X}=A.opts(),h;V&&z&&X?h=K.default.createServer({key:M.default.readFileSync(V),cert:M.default.readFileSync(z),ca:M.default.readFileSync(X)}):h=J.default.createServer();B(h);h.on("clientError",(n,r)=>{u.fatal("Client error: ",n),r.end()});h.listen(pe,fe,()=>{let n=h.address();n==null?u.fatal("Signaling server has no address"):console.log(typeof n=="string"?`Signaling server is listening on ${n}`:`Signaling server is listening on ${n.address}:${n.port}`)});
